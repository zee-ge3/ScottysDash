<!DOCTYPE html><meta charset="utf-8"><meta name="viewport"content="width=device-width,initial-scale=1,user-scalable=no"><title>Scotty's Dash</title><style>*{margin:0;padding:0}body{background:#000;overflow:hidden;touch-action:none}canvas{display:block}</style><canvas id="c"></canvas><script>let W,H,S,c=document.getElementById("c"),g=c.getContext("2d");function resize(){W=c.width=innerWidth,H=c.height=innerHeight,S=Math.min(W,H)}resize(),onresize=resize;const PI=Math.PI;let state=0,speed=0,turnRate=0,score=0,combo=1,maxCombo=1,hiScore=+localStorage.getItem("hs")||0,inputX=0,inputTuck=0,crashed=0,crashTimer=0,particles=[],shakeX=0,shakeY=0,trailHist=[],trailMaxLen=120,obstacles=[],lastSpawnZ=0,lastTime=0,pX=0,pY=0,pZ=0,camX=0,camY=3,camZ=-5,camAngle=0,pScrX=0,pScrY=0,pScrSc=1,slopeVal=0,lateralSlope=0,prevSpd=14,accelVal=0,smoothFov=.65,dogTurn=0,terrainSil=[],terrainSilD=[],dayT=0,dPh={};const dayPhases=[{sky:[[45,30,60],[75,50,70],[150,85,55],[215,125,55],[242,160,48],[252,185,65]],fog:[210,155,110],sunY:.35,sunA:.4,glow:.09,sB:[110,90,80],sR:[140,120,100],sunStr:1,mtn:[90,70,70]},{sky:[[8,5,25],[15,10,42],[25,15,58],[40,22,70],[50,28,80],[55,32,85]],fog:[35,28,65],sunY:.55,sunA:.05,glow:0,sB:[30,35,55],sR:[50,45,40],sunStr:0,mtn:[25,18,40]},{sky:[[20,18,55],[50,35,85],[110,55,90],[190,105,110],[225,140,115],[245,165,125]],fog:[180,130,140],sunY:.38,sunA:.3,glow:.07,sB:[100,85,80],sR:[130,110,90],sunStr:.7,mtn:[70,45,75]},{sky:[[58,127,183],[100,160,210],[140,195,230],[192,221,240],[210,230,240],[224,232,240]],fog:[192,221,240],sunY:.12,sunA:.6,glow:0,sB:[90,95,110],sR:[160,155,140],sunStr:.3,mtn:[100,110,130]}],dayB=[0,.3,.4,.7];function updateDay(){let e=dayT%1,t=e<dayB[1]?0:e<dayB[2]?1:e<dayB[3]?2:3,a=(e-dayB[t])/((t<3?dayB[t+1]:1)-dayB[t]),l=dayPhases[t],i=dayPhases[(t+1)%4],n=(e,t)=>e+(t-e)*a,o=(e,t)=>e.map((e,l)=>e+(t[l]-e)*a);dPh={sky:l.sky.map((e,t)=>o(e,i.sky[t])),fog:o(l.fog,i.fog),sunY:n(l.sunY,i.sunY),sunA:n(l.sunA,i.sunA),glow:n(l.glow,i.glow),sB:o(l.sB,i.sB),sR:o(l.sR,i.sR),sunStr:n(l.sunStr,i.sunStr),mtn:o(l.mtn,i.mtn)}}function lerp(e,t,a){return e+(t-e)*a}function project(e,t,a){let l=e-camX,i=t-camY,n=a-camZ,o=Math.cos(camAngle),r=Math.sin(camAngle),g=l*r+n*o;g<.3&&(g=.3);let s=H*smoothFov;return{x:W/2+(l*o-n*r)*s/g+shakeX,y:.38*H-i*s/g+shakeY,s:s/g,z:g}}function getHeight(e,t){return.25*(40*Math.sin(.018*t)+20*Math.sin(.046*t)+10*Math.sin(.102*t)+8*Math.sin(.2*t)+5*Math.sin(.08*e+.024*t))-.04*t}function curvature(e){return 5*Math.sin(.013*e)+3*Math.sin(.029*e)+1.5*Math.sin(.067*e)}function terrainType(e){let t=.5*Math.sin(.037*e)+.5;return e>500&&(t+=.15),e>1500&&(t+=.15),t<.25?0:t<.6?1:t<.8?2:3}function renderTerrain(){let e=.38*H,t=H*smoothFov,a=W>1200?4:3,l=dPh.fog[0],i=dPh.fog[1],n=dPh.fog[2];terrainSil=new Array(W).fill(H),terrainSilD=new Array(W).fill(999);for(let o=0;o<W;o+=a){let r=(o-W/2)/t,s=camAngle+Math.atan(r),c=Math.sin(s),h=Math.cos(s),f=H,p=1,d=999,m=Math.cos(Math.atan(r));for(let r=0;r<130;r++){let r=camX+c*p,s=camZ+h*p,u=getHeight(r,s),y=e+(camY-u)*t/(p*m)+shakeY;if(y<f){let e=1-Math.max(0,Math.min(1,(u-pY+8)/16)),t=dPh.sB[0]+e*dPh.sR[0],m=dPh.sB[1]+e*dPh.sR[1],T=dPh.sB[2]+e*dPh.sR[2],x=getHeight(r+.5*c,s+.5*h)-u;if(x>.03){let e=Math.min(.45,.8*x);t+=80*e,m+=60*e,T+=30*e}else if(x<-.03){let e=Math.min(.45,.8*-x);t-=50*e,m-=50*e,T-=20*e}let M=getHeight(r-.4,s),S=1.5*(getHeight(r+.4,s)-M);if(S>0){let e=Math.min(.5,.6*S)*dPh.sunStr;t+=60*e,m+=35*e,T-=10*e}else{let e=Math.min(.45,.5*-S)*dPh.sunStr;t-=40*e,m-=35*e,T+=10*e}let v=Math.min(1,p*p*4e-4),b=t*(1-v)+l*v,P=m*(1-v)+i*v,R=T*(1-v)+n*v;g.fillStyle=`rgb(${0|b},${0|P},${0|R})`,g.fillRect(o,0|y,a,f-y+1),f=y,d=p}if(f<=0)break;if(p+=.3+.012*p,p>50)break}let u=0|f;for(let e=o;e<o+a&&e<W;e++)terrainSil[e]=u,terrainSilD[e]=d}}function drawMtn(e,t,a,l,i,n,o){g.fillStyle=l,g.beginPath(),g.moveTo(-20,H);for(let l=-20;l<=W+20;l+=6){let n=l+i,o=Math.sin(.005*n+a)*t*.4+Math.sin(.013*n+2.3*a)*t*.35+Math.sin(.027*n+4.7*a)*t*.25;g.lineTo(l,e-o)}if(g.lineTo(W+20,H),g.closePath(),g.fill(),n){g.fillStyle=n,g.beginPath();let l=t*(o||.45);g.moveTo(-20,e-l);for(let n=-20;n<=W+20;n+=6){let o=n+i,r=l+Math.sin(.05*o+2*a)*t*.04,s=Math.sin(.005*o+a)*t*.4+Math.sin(.013*o+2.3*a)*t*.35+Math.sin(.027*o+4.7*a)*t*.25;g.lineTo(n,s>r?e-s:e-l)}g.lineTo(W+20,e-l),g.closePath(),g.fill()}}function render(){let e=g.createLinearGradient(0,0,0,H),t=[0,.2,.4,.6,.8,1];for(let a=0;a<6;a++){let l=dPh.sky[a];e.addColorStop(t[a],`rgb(${0|l[0]},${0|l[1]},${0|l[2]})`)}g.fillStyle=e,g.fillRect(0,0,W,H);let a=Math.max(0,Math.min(1,(.3-dPh.sunA)/.25));if(a>.01)for(let e=0;e<90;e++){let t=(2654435761*e+7>>>0)%W,l=(2246822519*e+13>>>0)%(.42*H),i=1+(1013904223*e>>>0)%3*.5,n=.3*Math.sin(.001*performance.now()+2.3*e)+.7;g.fillStyle=`rgba(255,255,240,${(a*n*.85).toFixed(2)})`,g.fillRect(t,l,i,i)}let l=.78*W,i=H*dPh.sunY;if(dPh.sunA>.02){let e=g.createRadialGradient(l,i,0,l,i,.35*H);e.addColorStop(0,`rgba(255,200,80,${dPh.sunA.toFixed(2)})`),e.addColorStop(.3,`rgba(255,160,60,${(.375*dPh.sunA).toFixed(2)})`),e.addColorStop(.7,`rgba(255,120,40,${(.125*dPh.sunA).toFixed(2)})`),e.addColorStop(1,"rgba(255,100,30,0)"),g.fillStyle=e,g.beginPath(),g.arc(l,i,.35*H,0,2*PI),g.fill();let t=g.createRadialGradient(l,i,3,l,i,.1*H);t.addColorStop(0,`rgba(255,250,200,${Math.min(.95,2.4*dPh.sunA).toFixed(2)})`),t.addColorStop(.2,`rgba(255,220,140,${Math.min(.7,1.75*dPh.sunA).toFixed(2)})`),t.addColorStop(.6,`rgba(255,180,80,${Math.min(.2,.5*dPh.sunA).toFixed(2)})`),t.addColorStop(1,"rgba(255,150,60,0)"),g.fillStyle=t,g.beginPath(),g.arc(l,i,.1*H,0,2*PI),g.fill(),g.fillStyle=`rgba(255,240,192,${Math.min(1,2.5*dPh.sunA).toFixed(2)})`,g.beginPath(),g.arc(l,i,11,0,2*PI),g.fill()}let n=-camAngle*W*.6,o=.05*camZ,r=(e,t,a)=>`rgb(${0|e},${0|t},${0|a})`,s=e=>[dPh.mtn[0]*(1-e)+dPh.fog[0]*e,dPh.mtn[1]*(1-e)+dPh.fog[1]*e,dPh.mtn[2]*(1-e)+dPh.fog[2]*e],c=e=>{let t=s(e);return[Math.min(255,t[0]+35),Math.min(255,t[1]+25),Math.min(255,t[2]+15)]},h=s(.7),f=s(.6),p=s(.45),d=s(.3),m=c(.75),u=c(.65),y=c(.5);if(drawMtn(.22*H,100,.5,r(...h),.15*-n+.2*o,r(...m),.2),drawMtn(.3*H,85,1.7,r(...f),.35*-n+.4*o,r(...u),.35),drawMtn(.38*H,65,3.1,r(...p),.7*-n+1*o,r(...y),.25),drawMtn(.45*H,50,5.3,r(...d),1.2*-n+1.5*o),0==state&&(g.textAlign="center",g.font="bold "+Math.max(50,.15*S|0)+"px monospace",g.fillStyle="rgb(255, 100, 0)",snowText("DASH",W/2,.38*H)),renderTerrain(),1!=state&&2!=state||renderObstacles(),speed>=17&&1==state){let e=10+14*(speed-13)/17,t=0|e;for(let a=0;a<t;a++){let t=Math.random()*PI*2,a=.25*W+Math.random()*W*.15,l=a+40+60*(accelVal+e),i=Math.cos(t),n=.6*Math.sin(t);g.strokeStyle=`rgba(255,230,180,${Math.min(.5,.3+.2*(e-10)/14)})`,g.lineWidth=1+1.5*Math.random(),g.beginPath(),g.moveTo(pScrX+i*a,pScrY+n*a),g.lineTo(pScrX+i*l,pScrY+n*l),g.stroke()}}if(trailHist.length>2){let e=.025,t=4,a=Math.ceil(trailHist.length/t);for(let l=0;l<2;l++){for(let i=0;i<a;i++){let a=i*t,n=Math.min(a+t,trailHist.length-1);if(a>=trailHist.length-1)break;let o=a/trailHist.length,r=.3*Math.max(.3,Math.min(1,4*o));g.beginPath();let s=!1;for(let t=a;t<=n;t++){let a=trailHist[t],i=0===l?a.lx:a.rx,n=0===l?a.lz:a.rz,o=project(i-e,getHeight(i,n),n);o.z<.5||o.z>45||(s?g.lineTo(o.x,o.y):(g.moveTo(o.x,o.y),s=!0))}for(let t=n;t>=a;t--){let a=trailHist[t],i=0===l?a.lx:a.rx,n=0===l?a.lz:a.rz,o=project(i+e,getHeight(i,n),n);o.z<.5||o.z>45||g.lineTo(o.x,o.y)}g.closePath(),g.fillStyle=`rgba(30,35,50,${r.toFixed(3)})`,g.fill()}if(trailHist.length>0){let t=trailHist[0],a=0===l?t.lx:t.rx,i=0===l?t.lz:t.rz,n=project(a,getHeight(a,i),i);if(n.z>.5&&n.z<45){let t=e*n.s*.8;t>.5&&(g.beginPath(),g.arc(n.x,n.y,t,0,2*PI),g.fillStyle="rgba(30,35,50,0.05)",g.fill())}}}}for(let e=0;e<skiers.length;e++){let t=skiers[e];if(t.trail.length<3)continue;let a=.02,l=4,i=Math.ceil(t.trail.length/l);for(let e=0;e<2;e++)for(let n=0;n<i;n++){let i=n*l,o=Math.min(i+l,t.trail.length-1);if(i>=t.trail.length-1)break;let r=i/t.trail.length,s=.25*Math.max(.3,Math.min(1,4*r));g.beginPath();let c=!1;for(let l=i;l<=o;l++){let i=t.trail[l],n=0===e?i.lx:i.rx,o=0===e?i.lz:i.rz,r=project(n-a,getHeight(n,o),o);r.z<.5||r.z>45||(c?g.lineTo(r.x,r.y):(g.moveTo(r.x,r.y),c=!0))}for(let l=o;l>=i;l--){let i=t.trail[l],n=0===e?i.lx:i.rx,o=0===e?i.lz:i.rz,r=project(n+a,getHeight(n,o),o);r.z<.5||r.z>45||g.lineTo(r.x,r.y)}g.closePath(),g.fillStyle=`rgba(30,35,50,${s.toFixed(3)})`,g.fill()}}let T=project(pX,pY,pZ);if(T.z>.3){pScrX=T.x,pScrY=T.y;let e=pScrSc=.024*S/T.z,t=4*pZ,a=pX+1.2*dogTurn,l=project(a,getHeight(a,pZ+2),pZ+2),i=.036*S/l.z,n=pX+.5*dogTurn,o=project(n,getHeight(n,pZ+1),pZ+1),r=.036*S/o.z,s=l.x-8*i,c=l.x+8*i,h=o.x-6*r,f=o.x+6*r,p=50*lateralSlope;if(drawDog(s,l.y+p,i,t),drawDog(c,l.y-p,i,t+.5*PI),drawDog(h,o.y+p,r,t+PI),drawDog(f,o.y-p,r,t+1.5*PI),1==state&&speed>5){let e=[{x:s,y:l.y+p,s:i,p:t},{x:c,y:l.y-p,s:i,p:t+.5*PI},{x:h,y:o.y+p,s:r,p:t+PI},{x:f,y:o.y-p,s:r,p:t+1.5*PI}];for(let t of e)Math.sin(t.p)>.5&&Math.random()<.6&&particles.push({x:t.x+(4*Math.random()-2)*t.s,y:t.y+2*t.s,vx:2*(Math.random()-.5),vy:1.8*-Math.random()-.5,life:14+10*Math.random()|0,ml:24,sz:2+2.5*Math.random()})}g.strokeStyle="#654",g.lineWidth=1,g.beginPath(),g.moveTo(s,l.y-5*i),g.lineTo(h,o.y-5*r),g.stroke(),g.beginPath(),g.moveTo(c,l.y-5*i),g.lineTo(f,o.y-5*r),g.stroke(),g.beginPath(),g.moveTo(h,o.y-5*r),g.lineTo(pScrX-3*e,pScrY-2*e),g.stroke(),g.beginPath(),g.moveTo(f,o.y-5*r),g.lineTo(pScrX+3*e,pScrY-2*e),g.stroke(),drawSled(pScrX,pScrY,e)}for(let e=particles.length-1;e>=0;e--){let t=particles[e];t.x+=t.vx,t.y+=t.vy,t.vy+=.1,t.life--,g.fillStyle=`rgba(255,230,190,${t.life/t.ml})`,g.fillRect(t.x,t.y,t.sz,t.sz),t.life<=0&&particles.splice(e,1)}if(dPh.glow>.005){let e=g.createRadialGradient(.78*W,H*dPh.sunY,0,.78*W,H*dPh.sunY,.6*W);e.addColorStop(0,`rgba(255,160,40,${dPh.glow.toFixed(3)})`),e.addColorStop(.5,`rgba(255,120,20,${(.5*dPh.glow).toFixed(3)})`),e.addColorStop(1,"rgba(255,80,10,0)"),g.fillStyle=e,g.fillRect(0,0,W,H)}}function drawDog(e,t,a,l){g.save(),g.translate(e,t),g.scale(a,a),g.rotate(.12*turnRate);let i=turnRate>.1?1:turnRate<-.1?-1:0,n=-(2*Math.abs(Math.sin(l)));g.fillStyle="#111",g.fillRect(-3,n-5,7,3);let o=i;g.fillRect(-2+o,n-8,5,3),g.fillRect(2+o,n-7,2,2),g.fillRect(-2+o,n-10,1,2),g.fillRect(2+o,n-10,1,2);let r=Math.sin(l);g.fillRect(-2,n-2,1,3+r),g.fillRect(2,n-2,1,3-r),g.fillRect(-1,n-2,1,2-r),g.fillRect(1,n-2,1,2+r);let s=Math.sin(1.3*l);g.fillRect(-3+s,n-7,1,2),g.fillStyle="#fff",g.fillRect(o,n-7,1,1);for(let e=0;e<7;e++)g.fillStyle=e%2==0?"#bb0000":"#006b00",g.fillRect(-3+e,n-5,1,1),g.fillStyle=e%2==0?"#006b00":"#bb0000",g.fillRect(-3+e,n-4,1,1);g.restore()}function drawSled(e,t,a){let l=.3*turnRate,i=6*l;g.save(),g.translate(e+i*a,t),g.scale(a,a),g.rotate(.4*l-.8*lateralSlope),g.fillStyle="rgba(0,0,0,0.15)",g.beginPath(),g.ellipse(0,12,10,3,0,0,2*PI),g.fill();let n=3*l;g.fillStyle="#654321",g.fillRect(-8,4+n,2,7-n),g.fillRect(6,4-n,2,7+n),g.fillStyle="#888",g.fillRect(-9,10,3,1),g.fillRect(6,10,3,1),g.fillStyle="#8B4513",g.fillRect(-7,5,14,1),g.fillRect(-7,8,14,1),g.fillStyle="#a06820",g.fillRect(-6,2,12,3),g.fillStyle="#654321",g.fillRect(-7,1,1,4),g.fillRect(6,1,1,4),g.fillRect(-7,1,14,1);let o=4*l;g.fillStyle="#445",g.fillRect(-4+o,-4,8,6),g.fillRect(-5+o,-3,1,2),g.fillRect(4+o,-3,1,2),g.fillRect(-6,-1,2,3),g.fillRect(4,-1,2,3),g.fillStyle="#dba",g.fillRect(-2+o,-7,4,3),g.fillStyle="#bb0000",g.fillRect(-3+o,-9,6,2),g.fillStyle="#fff",g.fillRect(-1+o,-10,2,1),g.fillStyle="#c49102",g.fillRect(-3,-4,6,1),g.restore()}function spraySnow(){for(let e=0;e<3;e++)particles.push({x:5+pScrX+(turnRate>0?7:-9)*pScrSc,y:pScrY+10*pScrSc,vx:3*turnRate+2*Math.random()-1,vy:3*-Math.random()-1,life:15+10*Math.random()|0,ml:25,sz:2+3*Math.random()})}function runnerSpray(){let e=.3*turnRate*.15-.8*lateralSlope,t=Math.cos(e),a=Math.sin(e),l=pScrX+(-8*t-11*a)*pScrSc,i=pScrX+(7*t-11*a)*pScrSc,n=pScrY+(-8*a+11*t)*pScrSc,o=pScrY+(7*a+11*t)*pScrSc,r=1+(speed/15|0);for(let e=0;e<r;e++)particles.push({x:l+3*Math.random()-1,y:n+2*Math.random(),vx:-.8-1*Math.random()+.3*turnRate,vy:1.5*-Math.random()-.3,life:10+8*Math.random()|0,ml:18,sz:1.5+2.5*Math.random()}),particles.push({x:i+3*Math.random()-1,y:o+2*Math.random(),vx:.8+1*Math.random()+.3*turnRate,vy:1.5*-Math.random()-.3,life:10+8*Math.random()|0,ml:18,sz:1.5+2.5*Math.random()})}function ambientSnow(){let e=2+(.25*speed|0);for(let t=0;t<e;t++)if(Math.random()<.6){let e=Math.random()*W,t=Math.random()*H*.7,a=e-.5*W,l=t-.38*H,i=Math.sqrt(a*a+l*l)||1,n=.4+1*Math.random()+.2*speed,o=l/i*n;o<.2&&(o=.2),particles.push({x:e,y:t,vx:a/i*n+.3*turnRate,vy:o+.3,life:60+40*Math.random()|0,ml:100,sz:1+1.5*Math.random(),grow:1})}}function seedRand(e,t){return(2147483647&(2654435761*e^2246822519*t))%1e4/1e4}function spawnObstacles(){let e=Math.max(3.6,3-pZ/2e3),t=Math.max(4.4,3.5-pZ/2e3),a=Math.floor((pZ-10)/e),l=Math.floor((pZ+80)/e),i=Math.floor((pX-60)/t),n=Math.floor((pX+60)/t);for(let o=a;o<=l;o++)for(let a=i;a<=n;a++){let l=1e4*o+a;if(spawnedCells.has(l))continue;spawnedCells.add(l);let i=seedRand(o,a),n=seedRand(37*a,73*o),r=o*e+n*e,g=a*t+seedRand(113*o,191*a)*t;if(r<pZ+30&&r>pZ-5&&Math.abs(g-pX)<10&&score<100)continue;let s=pZ<2e3?.275:pZ<4e3?.275+.075*(pZ-2e3)/2e3:.35+.075*Math.min(1,(pZ-4e3)/2e3),c=r-pZ,h=Math.abs(g-pX);if(!(c>5&&c<25&&h<4)&&i>s)continue;let f=n<.32?0:n<.48?1:n<.6?2:n<.72?3:n<.82?4:n<.92?5:6,p=.6+.8*seedRand(7*o,13*a),d=seedRand(31*o,59*a);obstacles.push({x:g,z:r,type:f,hit:!1,scale:p,variant:d,key:l})}}updateDay();let spawnedCells=new Set,skiers=[],nextSkierZ=50;function cleanupObstacles(){for(let e=obstacles.length-1;e>=0;e--){let t=obstacles[e];(t.z<pZ-25||Math.abs(t.x-pX)>80)&&(spawnedCells.delete(t.key),obstacles.splice(e,1))}}function updateSkiers(e){if(pZ>nextSkierZ){let e=seedRand(Math.floor(pZ),9999)<.5?-1:1;skiers.push({x:pX+e*(25+10*Math.random()),z:pZ+20+15*Math.random(),vx:-e*(5+3*Math.random()),vz:.3*speed+2*Math.random(),ph:Math.random()*PI*2,hit:!1,variant:Math.random(),trail:[]}),nextSkierZ=pZ+35+45*Math.random()}for(let t=skiers.length-1;t>=0;t--){let a=skiers[t];if(a.x+=a.vx*e,a.z+=a.vz*e,a.ph+=8*e,a.trail.unshift({lx:a.x-.15,lz:a.z,rx:a.x+.15,rz:a.z}),a.trail.length>80&&(a.trail.length=80),a.z<pZ-20||Math.abs(a.x-pX)>60){skiers.splice(t,1);continue}let l=!1;for(let e=0;e<obstacles.length;e++){let t=obstacles[e],i=t.scale||1,n=1===t.type?1.2:3===t.type?1.8:4===t.type?1.3:5===t.type?1.8:6===t.type?1.5:.7,o=3===t.type?.6:5===t.type?1.5:6===t.type?1.2:1;if(Math.abs(a.z-t.z)<o*i&&Math.abs(a.x-t.x)<n*i){l=!0;break}}if(l)skiers.splice(t,1);else if(!a.hit&&1===state&&Math.abs(a.z-pZ)<.7&&Math.abs(a.x-pX)<.5){a.hit=!0,crashed=1,state=2,crashTimer=1.5,playCrashSfx(),shakeX=20*(Math.random()-.5),shakeY=15*(Math.random()-.5);for(let e=0;e<25;e++)particles.push({x:pScrX+20*Math.random()-10,y:pScrY+10*Math.random()-5,vx:8*(Math.random()-.5),vy:6*-Math.random()-2,life:25+20*Math.random()|0,ml:45,sz:2+4*Math.random()});let e=Math.floor(pZ);if(e>hiScore){hiScore=e;try{localStorage.setItem("hs",hiScore)}catch(e){}}}}}function drawCrossingSkier(e,t,a,l,i,n,o){let r=dPh.fog[0],s=dPh.fog[1],c=dPh.fog[2];function h(e,t,a){return`rgb(${e*(1-n)+r*n|0},${t*(1-n)+s*n|0},${a*(1-n)+c*n|0})`}g.save(),g.translate(e,t),g.scale(a,a),l<0&&g.scale(-1,1);let f,p,d,m=.5*Math.sin(i);g.fillStyle=h(55,55,60),g.fillRect(-6,1,13,1),g.fillStyle=h(40,40,48),g.fillRect(-4+m,-1,2,2),g.fillRect(1-m,-1,2,2),g.fillStyle=h(35,35,45),g.fillRect(-3+m,-5,2,4),g.fillRect(0-m,-5,2,4),o<.25?(f=50,p=90,d=170):o<.5?(f=170,p=45,d=40):o<.75?(f=45,p=110,d=55):(f=190,p=120,d=35),g.fillStyle=h(f,p,d),g.fillRect(-2,-9,5,5),g.fillRect(-4+m,-8,2,3),g.fillRect(4-m,-8,2,3),g.fillStyle=h(140,140,145),g.fillRect(-5+m,-7,1,7),g.fillRect(5-m,-7,1,7),g.fillStyle=h(210,175,145),g.fillRect(-1,-12,3,3),g.fillStyle=h(Math.min(255,f+20),Math.min(255,p+20),Math.min(255,d+20)),g.fillRect(-1,-14,3,2),g.fillStyle=h(30,30,35),g.fillRect(0,-11,2,1),g.restore()}function drawTree(e,t,a,l,i,n){let o=dPh.fog[0],r=dPh.fog[1],s=dPh.fog[2];function c(e,t,a){return`rgb(${e*(1-i)+o*i|0},${t*(1-i)+r*i|0},${a*(1-i)+s*i|0})`}if(0===l){let l=16*a,i=7.2*a*(n<.33?.7:n<.66?1:1.2);g.fillStyle=c(70,45,20),g.fillRect(e-.2*a,t-.15*l,.4*a,.2*l);for(let a=0;a<3;a++){let n=t-.15*l-l*a*.22,o=i*(1-.22*a);g.fillStyle=c(20+8*a,70+10*a,30+5*a),g.beginPath(),g.moveTo(e-o,n),g.lineTo(e,n-.32*l),g.lineTo(e+o,n),g.closePath(),g.fill()}g.fillStyle=c(240,215,190);for(let a=0;a<3;a++){let n=t-.15*l-l*a*.22,o=i*(1-.22*a)*.65;g.beginPath(),g.moveTo(e-o,n-.04*l),g.lineTo(e,n-.32*l),g.lineTo(e+o,n-.04*l),g.closePath(),g.fill()}}else if(1===l){let l=6.4*a,i=.35*l;n<.25?(g.fillStyle=c(85,90,105),g.beginPath(),g.moveTo(e-l,t+i),g.lineTo(e-.7*l,t-1.1*l),g.lineTo(e+.3*l,t-1.5*l),g.lineTo(e+l,t-.7*l),g.lineTo(e+.8*l,t+i),g.closePath(),g.fill(),g.fillStyle=c(120,125,140),g.beginPath(),g.moveTo(e-.6*l,t-.6*l),g.lineTo(e+.3*l,t-1.5*l),g.lineTo(e+.7*l,t-.8*l),g.closePath(),g.fill(),g.fillStyle=c(210,220,230),g.beginPath(),g.moveTo(e-.4*l,t-.95*l),g.lineTo(e+.3*l,t-1.5*l),g.lineTo(e+.65*l,t-.8*l),g.closePath(),g.fill()):n<.5?(g.fillStyle=c(80,85,100),g.beginPath(),g.moveTo(e-.9*l,t+i),g.lineTo(e-l,t-.5*l),g.lineTo(e-.6*l,t-1.1*l),g.lineTo(e+.1*l,t-1.3*l),g.lineTo(e+.7*l,t-1*l),g.lineTo(e+.9*l,t-.4*l),g.lineTo(e+.8*l,t+i),g.closePath(),g.fill(),g.fillStyle=c(115,120,135),g.beginPath(),g.moveTo(e-.3*l,t-.7*l),g.lineTo(e+.1*l,t-1.3*l),g.lineTo(e+.6*l,t-.7*l),g.closePath(),g.fill(),g.fillStyle=c(210,220,230),g.beginPath(),g.moveTo(e-.3*l,t-.9*l),g.lineTo(e+.1*l,t-1.3*l),g.lineTo(e+.5*l,t-.85*l),g.closePath(),g.fill()):n<.75?(g.fillStyle=c(90,95,108),g.beginPath(),g.moveTo(e-1.2*l,t+i),g.lineTo(e-1*l,t-.6*l),g.lineTo(e-.2*l,t-.8*l),g.lineTo(e+.6*l,t-.7*l),g.lineTo(e+1.1*l,t-.3*l),g.lineTo(e+1*l,t+i),g.closePath(),g.fill(),g.fillStyle=c(125,130,142),g.beginPath(),g.moveTo(e-.5*l,t-.45*l),g.lineTo(e-.2*l,t-.8*l),g.lineTo(e+.5*l,t-.55*l),g.closePath(),g.fill(),g.fillStyle=c(210,220,230),g.beginPath(),g.moveTo(e-.6*l,t-.5*l),g.lineTo(e-.2*l,t-.8*l),g.lineTo(e+.4*l,t-.55*l),g.closePath(),g.fill()):(g.fillStyle=c(78,82,98),g.beginPath(),g.moveTo(e-.8*l,t+i),g.lineTo(e-.9*l,t-.4*l),g.lineTo(e-.4*l,t-.9*l),g.lineTo(e+.15*l,t-1.2*l),g.lineTo(e+.5*l,t-.8*l),g.lineTo(e+.7*l,t+i),g.closePath(),g.fill(),g.fillStyle=c(95,100,115),g.beginPath(),g.moveTo(e-.3*l,t-.7*l),g.lineTo(e,t-1.4*l),g.lineTo(e+.35*l,t-.9*l),g.closePath(),g.fill(),g.fillStyle=c(215,225,235),g.fillRect(e-.35*l,t-.72*l,.55*l,.08*l),g.beginPath(),g.moveTo(e-.15*l,t-1.1*l),g.lineTo(e,t-1.4*l),g.lineTo(e+.2*l,t-1.1*l),g.closePath(),g.fill())}else if(2===l){let l=14*a,i=(n-.5)*a*2;if(g.strokeStyle=c(60,42,25),n>.85){g.lineWidth=Math.max(1.5,1*a);let n=t-.55*l;g.beginPath(),g.moveTo(e,t),g.lineTo(e+.55*i,n),g.stroke(),g.lineWidth=Math.max(1,.7*a),g.beginPath(),g.moveTo(e+.55*i,n),g.lineTo(e+i-3*a,t-l),g.stroke(),g.beginPath(),g.moveTo(e+.55*i,n),g.lineTo(e+i+3.5*a,t-.9*l),g.stroke(),g.lineWidth=Math.max(1,.4*a),g.beginPath(),g.moveTo(e+i-2*a,t-.85*l),g.lineTo(e+i-4.5*a,t-.95*l),g.stroke(),g.beginPath(),g.moveTo(e+i+2.5*a,t-.78*l),g.lineTo(e+i+5*a,t-.88*l),g.stroke()}else{let o=n<.2?2:n<.5?3:n<.8?4:5;g.lineWidth=Math.max(1.5,1*a),g.beginPath(),g.moveTo(e,t),g.lineTo(e+i,t-l),g.stroke(),g.lineWidth=Math.max(1,.6*a);for(let r=0;r<o;r++){let s=.35+.55*r/o,c=r%2==0?-1:1,h=e+i*s+c*a*(3+3*n),f=t-l*(s+.15+.05*n);g.beginPath(),g.moveTo(e+i*s,t-l*s),g.lineTo(h,f),g.stroke(),o>=4&&r>0&&(g.lineWidth=Math.max(1,.35*a),g.beginPath(),g.moveTo(h,f),g.lineTo(h+c*a*(1+n),f-a*(1+.5*n)),g.stroke(),g.lineWidth=Math.max(1,.6*a))}}}else if(3===l){let l=a*(8+6*n),o=a*(2.2+1.2*n),r=.3*(n-.5);g.save(),g.translate(e,t),g.rotate(r),n>.5&&g.scale(-1,1),g.fillStyle=`rgba(0,0,0,${(.12*(1-i)).toFixed(2)})`,g.beginPath(),g.ellipse(0,.1*o,.52*l,.25*o,0,0,2*PI),g.fill(),g.fillStyle=c(72,50,28),g.fillRect(-l/2,-o,l,o),g.fillStyle=c(92,65,35),g.fillRect(-l/2,-o,l,.3*o),g.fillStyle=c(52,36,18),g.fillRect(-l/2,.2*-o,l,.2*o),g.fillStyle=c(88,65,38),g.beginPath(),g.ellipse(-l/2,.5*-o,.52*o,.52*o,0,0,2*PI),g.fill(),g.fillStyle=c(105,80,50),g.beginPath(),g.ellipse(-l/2,.5*-o,.35*o,.35*o,0,0,2*PI),g.fill(),g.strokeStyle=c(62,42,22),g.lineWidth=Math.max(1,.15*a),g.beginPath(),g.ellipse(-l/2,.5*-o,.22*o,.22*o,0,0,2*PI),g.stroke(),g.beginPath(),g.ellipse(-l/2,.5*-o,.08*o,.08*o,0,0,2*PI),g.stroke();let s=l/2;g.fillStyle=c(60,42,22),g.beginPath(),g.moveTo(s,.05*-o),g.lineTo(s+.15*o,.25*-o),g.lineTo(s-.1*o,.45*-o),g.lineTo(s+.2*o,.65*-o),g.lineTo(s+.05*o,.85*-o),g.lineTo(s,-o),g.closePath(),g.fill(),g.fillStyle=c(230,240,245),g.fillRect(.4*-l,1.05*-o,.8*l,.12*o),g.restore()}else if(4===l){let l=8*a,i=.3*l;g.fillStyle=c(72,78,92),g.beginPath(),g.moveTo(e-.7*l,t+i),g.lineTo(e-.8*l,t-.5*l),g.lineTo(e-.3*l,t-.9*l),g.lineTo(e+.2*l,t-.85*l),g.lineTo(e+.6*l,t-.4*l),g.lineTo(e+.5*l,t+i),g.closePath(),g.fill(),g.fillStyle=c(100,106,120),g.beginPath(),g.moveTo(e-.2*l,t-.5*l),g.lineTo(e+.1*l,t-.85*l),g.lineTo(e+.5*l,t-.45*l),g.closePath(),g.fill();let o=n>.5?.6*l:.5*-l;if(g.fillStyle=c(80,86,100),g.beginPath(),g.moveTo(e+o-.4*l,t+.5*i),g.lineTo(e+o-.35*l,t-.45*l),g.lineTo(e+o+.1*l,t-.6*l),g.lineTo(e+o+.35*l,t-.3*l),g.lineTo(e+o+.3*l,t+.5*i),g.closePath(),g.fill(),n>.35){let a=n>.5?.4*-l:.5*l;g.fillStyle=c(88,92,108),g.beginPath(),g.moveTo(e+a-.2*l,t+.3*i),g.lineTo(e+a,t-.25*l),g.lineTo(e+a+.2*l,t+.3*i),g.closePath(),g.fill()}g.fillStyle=c(212,222,232),g.beginPath(),g.moveTo(e-.4*l,t-.65*l),g.lineTo(e-.05*l,t-.9*l),g.lineTo(e+.3*l,t-.6*l),g.closePath(),g.fill(),g.beginPath(),g.moveTo(e+o-.15*l,t-.4*l),g.lineTo(e+o+.05*l,t-.6*l),g.lineTo(e+o+.25*l,t-.35*l),g.closePath(),g.fill()}else if(5===l){let l=14*a,i=.55*l;g.fillStyle=c(65,70,85),g.beginPath(),g.moveTo(e-.5*l,t+i),g.lineTo(e-1*l,t-.3*l),g.lineTo(e-.75*l,t-.7*l),g.lineTo(e-.2*l,t-1.05*l),g.lineTo(e+.3*l,t-1.1*l),g.lineTo(e+.7*l,t-.8*l),g.lineTo(e+.95*l,t-.35*l),g.lineTo(e+.45*l,t+i),g.closePath(),g.fill(),g.fillStyle=c(90,95,112),g.beginPath(),g.moveTo(e+.3*l,t-1.1*l),g.lineTo(e+.7*l,t-.8*l),g.lineTo(e+.95*l,t-.35*l),g.lineTo(e+.45*l,t+i),g.lineTo(e+.1*l,t+i),g.lineTo(e-.05*l,t-.5*l),g.closePath(),g.fill(),g.fillStyle=c(105,110,128),g.beginPath(),g.moveTo(e-.2*l,t-1.05*l),g.lineTo(e+.3*l,t-1.1*l),g.lineTo(e+.7*l,t-.8*l),g.lineTo(e+.1*l,t-.7*l),g.lineTo(e-.4*l,t-.65*l),g.closePath(),g.fill(),g.strokeStyle=c(45,48,60),g.lineWidth=Math.max(1,.3*a),g.beginPath(),g.moveTo(e-.15*l,t-.95*l),g.lineTo(e-.05*l,t-.5*l),g.lineTo(e+.15*l,t-.1*l),g.stroke(),g.fillStyle=c(215,225,235),g.beginPath(),g.moveTo(e-.6*l,t-.6*l),g.lineTo(e-.2*l,t-1.05*l),g.lineTo(e+.3*l,t-1.1*l),g.lineTo(e+.6*l,t-.75*l),g.lineTo(e+.1*l,t-.7*l),g.closePath(),g.fill(),g.fillStyle=c(210,220,232),g.fillRect(e-.12*l,t-.52*l,.25*l,.06*l)}else if(6===l){let l=22*a,i=10*a,o=15*(n-.5),r=n<.3?3:4,s=[{dx:.8*-i,dh:.85+.1*n,dw:.85},{dx:.6*i,dh:.95,dw:.95},{dx:.05*-i,dh:1.1+.15*n,dw:1.05},{dx:1.2*i,dh:.78,dw:.75}];for(let n=0;n<r;n++){let r=s[n],h=e+r.dx,f=l*r.dh,p=.35*i*r.dw;g.fillStyle=c(70,45,20),g.fillRect(h-.15*a,t-.15*f,.3*a,.2*f);for(let e=0;e<2;e++){let a=t-.15*f-f*e*.25,l=a-.38*f,i=p*(1-.2*e);g.fillStyle=c(18+10*e+3*n,60+12*e+o+4*n,25+5*e),g.beginPath(),g.moveTo(h-i,a),g.lineTo(h,l),g.lineTo(h+i,a),g.closePath(),g.fill()}}for(let a=0;a<r;a++){let n=s[a],o=e+n.dx,r=l*n.dh,h=.35*i*n.dw;for(let e=0;e<2;e++){let a=t-.15*r-r*e*.25,l=a-.38*r,i=a-.55*(a-l),n=.5*(h*(1-.2*e));g.fillStyle=c(228,238,244),g.beginPath(),g.moveTo(o-n,i),g.lineTo(o,l),g.lineTo(o+n,i),g.closePath(),g.fill()}}}}function renderObstacles(){let e=[];for(let t=0;t<obstacles.length;t++){let a=obstacles[t],l=getHeight(a.x,a.z),i=project(a.x,l,a.z);if(i.z<.5||i.z>45||i.x<-200||i.x>W+200)continue;let n=0,o=0;for(let e=1;e<12;e++){let t=e/12,i=camX+(a.x-camX)*t,r=camZ+(a.z-camZ)*t,g=camY+(l-camY)*t,s=getHeight(i,r)-g;s>n&&(n=s,o=t)}let r=null;n>0&&(r={x:camX+(a.x-camX)*o,z:camZ+(a.z-camZ)*o});let g=Math.round(Math.max(0,Math.min(W-1,i.x))),s=i.y;i.y<terrainSil[g]&&(s=terrainSil[g]),e.push({kind:"ob",ob:a,p:i,wy:l,crest:r,baseY:s,scale:a.scale||1,variant:a.variant||0})}for(let t=0;t<skiers.length;t++){let a=skiers[t],l=getHeight(a.x,a.z),i=project(a.x,l,a.z);if(i.z<.5||i.z>45||i.x<-200||i.x>W+200)continue;let n=0,o=0;for(let e=1;e<12;e++){let t=e/12,i=camX+(a.x-camX)*t,r=camZ+(a.z-camZ)*t,g=camY+(l-camY)*t,s=getHeight(i,r)-g;s>n&&(n=s,o=t)}let r=null;n>0&&(r={x:camX+(a.x-camX)*o,z:camZ+(a.z-camZ)*o});let g=Math.round(Math.max(0,Math.min(W-1,i.x))),s=i.y;i.y<terrainSil[g]&&(s=terrainSil[g]),e.push({kind:"sk",sk:a,p:i,baseY:s,crest:r})}e.sort((e,t)=>t.p.z-e.p.z);for(let t=0;t<e.length;t++){let a=e[t],{p:l,baseY:i}=a,n=Math.min(1,l.z*l.z*6e-4);if("sk"===a.kind){let e=a.sk,t=.036*S/l.z;if(g.save(),a.crest){let e=12,t=10;g.beginPath();let l=a.crest.x-e,i=project(l,getHeight(l,a.crest.z),a.crest.z);g.moveTo(i.x,0);let n=a.crest.x+e,o=project(n,getHeight(n,a.crest.z),a.crest.z);g.lineTo(o.x,0);for(let l=t;l>=0;l--){let i=a.crest.x+(l/t-.5)*e*2,n=project(i,getHeight(i,a.crest.z),a.crest.z);g.lineTo(n.x,n.y)}g.closePath(),g.clip()}g.beginPath(),g.rect(-20,0,W+40,i),g.clip(),Math.random()<.35&&(g.fillStyle=`rgba(255,255,255,${(.25*(1-n)).toFixed(2)})`,g.fillRect(l.x+(Math.random()-.5)*t*8,i-Math.random()*t*4,2*t,t)),drawCrossingSkier(l.x,i,t,e.vx>0?1:-1,e.ph,n,e.variant),g.restore();continue}let{ob:o,wy:r,crest:s,scale:c,variant:h}=a,f=.107*S/l.z*c,p=.18*(1-n)*dPh.sunStr,d=3.5*f,m=.5*f;if(0===o.type?d=4.5*f:2===o.type?d=4*f:1===o.type||4===o.type?(d=2.5*f,m=.7*f):3===o.type?(d=3*f,m=.8*f):5===o.type?(d=5*f,m=1*f):6===o.type&&(d=5*f),g.save(),g.translate(l.x,i),g.transform(1,0,-.6,.18,0,0),g.fillStyle=`rgba(40,25,30,${p.toFixed(2)})`,g.fillRect(-d,.5*-m,d,m),g.restore(),g.save(),s){let e=12,t=10;g.beginPath();let a=s.x-e,l=project(a,getHeight(a,s.z),s.z);g.moveTo(l.x,0);let i=s.x+e,n=project(i,getHeight(i,s.z),s.z);g.lineTo(n.x,0);for(let a=t;a>=0;a--){let l=s.x+(a/t-.5)*e*2,i=project(l,getHeight(l,s.z),s.z);g.lineTo(i.x,i.y)}g.closePath(),g.clip()}g.beginPath(),g.rect(-20,0,W+40,i),g.clip(),drawTree(l.x,i,f,o.type,n,h),g.restore()}}function checkCollisions(){for(let e=0;e<obstacles.length;e++){let t=obstacles[e];if(t.hit)continue;let a=t.z-pZ,l=t.x-pX,i=t.scale||1,n=1===t.type?1.2:3===t.type?1.8:4===t.type?1.3:5===t.type?1.8:6===t.type?1.5:.7,o=3===t.type?.6:5===t.type?1.5:6===t.type?1.2:1;if(Math.abs(a)<o*i&&Math.abs(l)<n*i){t.hit=!0,crashed=1,state=2,crashTimer=1.5,playCrashSfx(),shakeX=20*(Math.random()-.5),shakeY=15*(Math.random()-.5);for(let e=0;e<25;e++)particles.push({x:pScrX+20*Math.random()-10,y:pScrY+10*Math.random()-5,vx:8*(Math.random()-.5),vy:6*-Math.random()-2,life:25+20*Math.random()|0,ml:45,sz:2+4*Math.random()});let e=Math.floor(pZ);if(e>hiScore){hiScore=e;try{localStorage.setItem("hs",hiScore)}catch(e){}}return}}}function update(e){if(1!=state)return;e>.1&&(e=.1),dayT=(dayT+speed*e*.5*.0032)%1,slopeVal=getHeight(pX,pZ+2)-getHeight(pX,pZ-2),lateralSlope=(getHeight(pX+2,pZ)-getHeight(pX-2,pZ))/4;let t=slopeVal<0?.12*-slopeVal:.02*-slopeVal,a=terrainType(Math.floor(pZ)),l=0==a?.015:1==a?.025:2==a?.008:.02,i=9.8*t,n=.1*Math.abs(turnRate),o=speed*speed*.001*(inputTuck?.6:1),r=Math.min(1,score/8e3),g=14*Math.min(1,pZ/30)+10*r,s=35+15*r,c=1+.6*r;speed+=i*e,speed-=(l+n)*speed*e,speed-=o*e,slopeVal>0&&(speed-=slopeVal*slopeVal*.15*e),speed=Math.max(g,Math.min(speed,s)),accelVal=lerp(accelVal,Math.max(0,(speed-prevSpd)/e),Math.min(1,10*e)),prevSpd=speed;let h=.002*curvature(pZ);turnRate+=(2.5*inputX*c-turnRate)*e*1.2,pX+=dogTurn*e*4*c,pX+=h*speed*e*.1,pZ+=speed*e*.5,pY=getHeight(pX,pZ);let f=.42*Math.min(1,Math.max(.35,.5*-slopeVal));trailHist.unshift({lx:pX-.2,lz:pZ-f,rx:pX+.2,rz:pZ-f}),trailHist.length>trailMaxLen&&(trailHist.length=trailMaxLen),score+=speed*e*2,smoothFov=lerp(smoothFov,.65+.07*slopeVal,Math.min(1,3*e));let p=Math.min(1,5*e),d=Math.min(2.5,Math.max(0,-slopeVal));camX=lerp(camX,pX,Math.min(1,2.5*e)),camY=lerp(camY,pY+2+1.2*d,Math.min(1,8*e)),camZ=lerp(camZ,pZ-3-.6*d,p),camAngle=Math.atan2(pX-camX,pZ+4-camZ),Math.abs(turnRate)>.5&&speed>3&&spraySnow(),ambientSnow(),speed>5&&runnerSpray(),dogTurn=lerp(dogTurn,turnRate,Math.min(1,2*e)),shakeX*=.85,shakeY*=.85,Math.abs(shakeX)<.5&&(shakeX=0),Math.abs(shakeY)<.5&&(shakeY=0),spawnObstacles(),cleanupObstacles(),1===state&&updateSkiers(e),checkCollisions()}function snowText(e,t,a){g.shadowColor="rgba(150,200,255,0.7)",g.shadowBlur=6,g.strokeStyle="rgba(180,220,255,0.5)",g.lineWidth=2,g.strokeText(e,t,a),g.fillText(e,t,a),g.shadowBlur=0}function drawHUD(){if(1!=state)return;let e=Math.max(14,.04*S|0);g.textAlign="left",g.font="bold "+e+"px monospace",g.fillStyle="#fff",snowText(Math.floor(pZ)+"m",10,e+5),snowText(speed.toFixed(1)+" mps",10,2*e+10)}function drawTitle(){g.textAlign="center",g.font="bold "+Math.max(36,.1*S|0)+"px monospace",g.fillStyle="rgb(255, 255, 200)",snowText("Scotty's",W/2,.2*H),Date.now()%1e3<600&&(g.fillStyle="#fff",g.font="bold "+Math.max(18,.05*S|0)+"px monospace",snowText("TAP TO START",W/2,.62*H)),hiScore>0&&(g.fillStyle="#ff0",g.font=Math.max(14,.04*S|0)+"px monospace",snowText("Best: "+hiScore+"m",W/2,.72*H)),g.fillStyle="rgba(255,230,190,0.5)",g.font=Math.max(11,.03*S|0)+"px monospace",snowText("Touch sides to steer",W/2,.82*H),snowText("Arrow keys / mouse on desktop",W/2,.87*H)}function drawGameOver(){g.textAlign="center",g.fillStyle="rgba(0,0,0,0.5)",g.fillRect(0,.2*H,W,.6*H),g.fillStyle="#f44",g.font="bold "+Math.max(32,.09*S|0)+"px monospace",snowText("CRASHED!",W/2,.35*H),g.fillStyle="#fff",g.font=Math.max(15,.05*S|0)+"px monospace",snowText("Distance: "+Math.floor(pZ)+"m",W/2,.47*H),Math.floor(pZ)>=hiScore&&hiScore>0&&(g.fillStyle="#ff0",snowText("NEW RECORD!",W/2,.56*H)),Date.now()%1e3<600&&(g.fillStyle="#fff",g.font="bold "+Math.max(16,.045*S|0)+"px monospace",snowText("TAP TO RETRY",W/2,.68*H))}function resetGame(){pX=0,pZ=0;for(let e=0;e<200;e++)if(getHeight(0,e+2)-getHeight(0,e-2)<-.3){pZ=e;break}pY=getHeight(0,pZ),speed=0,turnRate=0,camX=0,camY=pY+2,camZ=pZ-3,camAngle=0,score=0,combo=1,maxCombo=1,crashed=0,crashTimer=0,particles=[],trailHist=[],shakeX=0,shakeY=0,prevSpd=14,accelVal=0,smoothFov=.65,dogTurn=0,obstacles=[],lastSpawnZ=0,spawnedCells=new Set,skiers=[],nextSkierZ=50,dayT=0}let keys={},mouseDown=0,mouseX=0,mouseY=0;function handlePointer(e){e.preventDefault();let t=e.touches?e.touches[0]:e;mouseX=t.clientX,mouseY=t.clientY,mouseDown=1}onkeydown=e=>{keys[e.key]=1,1!=state&&startOrRetry()},onkeyup=e=>{keys[e.key]=0},c.addEventListener("touchstart",e=>{handlePointer(e),1!=state&&startOrRetry()},{passive:!1}),c.addEventListener("touchmove",e=>{handlePointer(e)},{passive:!1}),c.addEventListener("touchend",e=>{e.preventDefault(),mouseDown=0},{passive:!1}),c.addEventListener("mousedown",e=>{mouseDown=1,mouseX=e.clientX,mouseY=e.clientY,1!=state&&startOrRetry()}),c.addEventListener("mousemove",e=>{mouseDown&&(mouseX=e.clientX,mouseY=e.clientY)}),c.addEventListener("mouseup",()=>{mouseDown=0});let ax,aM,noiseBuf,aWindG,aWindF,wg2,aPadG,padF,aRunG,aRunF,aCarvG,aCarvF,aCarvF2,aChimeG,aInited=0,padOscs=[],chordIdx=0,chordTimer=7,chimeTimer=3,arpStep=0,arpTimer=1,carveBurst=0,prevTurnAbs=0,carveVol=0,smoothTempo=1,chords=[[65.4,130.8,164.8,196],[55,130.8,164.8,196],[43.7,130.8,164.8,174.6],[49,123.5,146.8,196]],chimeScales=[[523.3,659.3,784,1046.5,1318.5],[523.3,659.3,784,880,1046.5],[523.3,587.3,698.5,880,1046.5],[587.3,784,988,1174.7,1568]];function initAudio(){if(aInited)return;ax=new(window.AudioContext||window.webkitAudioContext),aInited=1,aM=ax.createGain(),aM.gain.value=.6,aM.connect(ax.destination),noiseBuf=ax.createBuffer(1,ax.sampleRate,ax.sampleRate);let e=noiseBuf.getChannelData(0);for(let t=0;t<e.length;t++)e[t]=2*Math.random()-1;let t=ax.createBufferSource();t.buffer=noiseBuf,t.loop=!0,aWindF=ax.createBiquadFilter(),aWindF.type="bandpass",aWindF.frequency.value=400,aWindF.Q.value=.35,aWindG=ax.createGain(),aWindG.gain.value=.15,t.connect(aWindF),aWindF.connect(aWindG),aWindG.connect(aM),t.start();let a=ax.createBufferSource();a.buffer=noiseBuf,a.loop=!0;let l=ax.createBiquadFilter();l.type="bandpass",l.frequency.value=180,l.Q.value=.4,wg2=ax.createGain(),wg2.gain.value=.04,a.connect(l),l.connect(wg2),wg2.connect(aM),a.start();let i=ax.createOscillator();i.type="sine",i.frequency.value=.15;let n=ax.createGain();n.gain.value=.06,i.connect(n),n.connect(wg2.gain),i.start(),padF=ax.createBiquadFilter(),padF.type="lowpass",padF.frequency.value=600,padF.Q.value=.3,aPadG=ax.createGain(),aPadG.gain.value=.04,padF.connect(aPadG),aPadG.connect(aM);for(let e=0;e<4;e++){let t=ax.createOscillator();t.type="triangle",t.frequency.value=chords[0][e],t.connect(padF),t.start(),padOscs.push(t)}let o=ax.createOscillator();o.type="sine",o.frequency.value=.06;let r=ax.createGain();r.gain.value=.03,o.connect(r),r.connect(aPadG.gain),o.start();let g=ax.createOscillator();g.type="sine",g.frequency.value=.13;let s=ax.createGain();s.gain.value=.5,g.connect(s),s.connect(padOscs[2].detune),g.start();let c=ax.createBufferSource();c.buffer=noiseBuf,c.loop=!0,aRunF=ax.createBiquadFilter(),aRunF.type="highpass",aRunF.frequency.value=2e3,aRunF.Q.value=.3,aRunG=ax.createGain(),aRunG.gain.value=0,c.connect(aRunF),aRunF.connect(aRunG),aRunG.connect(aM),c.start();let h=ax.createBufferSource();h.buffer=noiseBuf,h.loop=!0,aCarvF=ax.createBiquadFilter(),aCarvF.type="bandpass",aCarvF.frequency.value=600,aCarvF.Q.value=.6,aCarvF2=ax.createBiquadFilter(),aCarvF2.type="peaking",aCarvF2.frequency.value=1200,aCarvF2.gain.value=5,aCarvF2.Q.value=.5,aCarvG=ax.createGain(),aCarvG.gain.value=0,h.connect(aCarvF),aCarvF.connect(aCarvF2),aCarvF2.connect(aCarvG),aCarvG.connect(aM),h.start(),aChimeG=ax.createGain(),aChimeG.gain.value=.4,aChimeG.connect(aM)}function playChime(){let e=chimeScales[chordIdx],t=e[Math.random()*e.length|0],a=ax.currentTime,l=ax.createGain();l.gain.setValueAtTime(0,a),l.gain.linearRampToValueAtTime(.15,a+.25),l.gain.setTargetAtTime(0,a+.3,.7+.8*Math.random()),l.connect(aChimeG);let i=ax.createOscillator();i.type="sine",i.frequency.value=t,i.connect(l),i.start(a),i.stop(a+5);let n=ax.createGain();n.gain.value=.25,n.connect(l);let o=ax.createOscillator();o.type="sine",o.frequency.value=2.003*t,o.connect(n),o.start(a),o.stop(a+5);let r=ax.createGain();r.gain.value=.08,r.connect(l);let g=ax.createOscillator();g.type="sine",g.frequency.value=3.01*t,g.connect(r),g.start(a),g.stop(a+5)}function playArpPhrase(){let e=chimeScales[chordIdx],t=2+(2*Math.random()|0),a=Math.random()*(e.length-t)|0,l=ax.currentTime,i=.18*smoothTempo;for(let n=0;n<t;n++){let t=e[a+n],o=ax.createGain();o.gain.setValueAtTime(0,l+n*i),o.gain.linearRampToValueAtTime(.12,l+n*i+.03),o.gain.setTargetAtTime(0,l+n*i+.05,.5+.4*Math.random()),o.connect(aChimeG);let r=ax.createOscillator();r.type="sine",r.frequency.value=t,r.connect(o),r.start(l+n*i),r.stop(l+n*i+4);let g=ax.createGain();g.gain.value=.25,g.connect(o);let s=ax.createOscillator();s.type="sine",s.frequency.value=2.003*t,s.connect(g),s.start(l+n*i),s.stop(l+n*i+4)}}function playBgArp(){let e=chimeScales[chordIdx],t=.5*e[arpStep%e.length],a=ax.currentTime,l=ax.createGain();l.gain.setValueAtTime(.06+.03*Math.random(),a),l.gain.setTargetAtTime(0,a+.05,.6),l.connect(aChimeG);let i=ax.createOscillator();i.type="sine",i.frequency.value=t,i.connect(l),i.start(a),i.stop(a+3),arpStep++}function playCrashSfx(){if(!aInited)return;let e=.3*ax.sampleRate|0,t=ax.createBuffer(1,e,ax.sampleRate),a=t.getChannelData(0);for(let t=0;t<e;t++)a[t]=(2*Math.random()-1)*Math.exp(-t/(.08*ax.sampleRate));let l=ax.createBufferSource();l.buffer=t;let i=ax.createBiquadFilter();i.type="lowpass",i.frequency.value=800;let n=ax.createGain();n.gain.value=1,l.connect(i),i.connect(n),n.connect(aM),l.start()}function updateAudio(e){let t=Math.max(0,Math.min(1,(speed-14)/36)),a=Math.max(.35,Math.min(1.5,1+.35*slopeVal));smoothTempo=lerp(smoothTempo,a,Math.min(1,2*e)),aWindG.gain.value=.04+.06*t,aWindF.frequency.value=250+600*t,aRunG.gain.value=.04*t,aRunF.frequency.value=1500+2500*t;let l=Math.abs(turnRate),i=l-prevTurnAbs;i>.005&&l>.15&&(carveBurst=Math.min(1,carveBurst+8*i)),carveBurst*=Math.max(0,1-2.5*e);let n=Math.min(1,1.2*l)*Math.max(.3,t)*.03;if(carveVol=.1*carveBurst+n,aCarvG.gain.value=carveVol,aCarvF.frequency.value=400+350*l+200*carveBurst,aCarvF.Q.value=.5+1*carveBurst,prevTurnAbs=l,chordTimer-=e/smoothTempo,chordTimer<=0){chordIdx=(chordIdx+1)%4;let e=ax.currentTime;for(let t=0;t<4;t++)padOscs[t].frequency.setTargetAtTime(chords[chordIdx][t],e,1.5);chordTimer=6+3*Math.random()}1==state&&(chimeTimer-=e/smoothTempo,chimeTimer<=0&&(Math.random()<.3?(playArpPhrase(),chimeTimer=4+5*Math.random()):(playChime(),chimeTimer=2+4*Math.random())),arpTimer-=e/smoothTempo,arpTimer<=0&&(playBgArp(),arpTimer=.8+.4*Math.random())),aM.gain.value=2==state?Math.max(.15,aM.gain.value-.5*e):Math.min(.6,aM.gain.value+.3*e)}function startOrRetry(){initAudio(),0==state?(state=1,resetGame()):2==state&&crashTimer<=0&&(state=0)}function processInput(){if(inputX=0,inputTuck=0,(keys.ArrowLeft||keys.a)&&(inputX=-1),(keys.ArrowRight||keys.d)&&(inputX=1),(keys.ArrowDown||keys.s)&&(inputTuck=1),mouseDown){let e=(mouseX-W/2)/(W/2);inputX=Math.max(-1,Math.min(1,1.5*e)),mouseY>.7*H&&(inputTuck=1)}}function frame(e){let t=(e-lastTime)/1e3;lastTime=e,t>.2&&(t=.016),processInput(),1==state&&update(t),2==state&&(crashTimer-=t,shakeX*=.9,shakeY*=.9),aInited&&updateAudio(t),updateDay(),render(),drawHUD(),0==state&&drawTitle(),2==state&&drawGameOver(),requestAnimationFrame(frame)}for(let e=0;e<200;e++)if(getHeight(0,e+2)-getHeight(0,e-2)<-.3){pZ=e;break}pY=getHeight(0,pZ),camY=pY+2,camZ=pZ-3,lastTime=performance.now(),requestAnimationFrame(frame)</script>